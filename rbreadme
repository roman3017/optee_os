export OPTEES=`pwd`/
export OPTEEL=/local/home/roman/projects/optee_linuxdriver/
export OPTEEC=/local/home/roman/projects/optee_client/
export OPTEET=/local/home/roman/projects/optee_test/
export BUILDROOT=/local/home/roman/projects/zyboradio/buildroot/

export CROSS_COMPILE=${BUILDROOT}output/host/usr/bin/arm-none-linux-gnueabi-
#export CROSS_COMPILE=arm-none-eabi-

export DEBUG=1
export ARCH=arm
export CFG_ARM32=y
export CFG_TEE_CORE_CORE_TARGET=arm1176jzf-s
export CFG_TEE_CORE_LOG_LEVEL=4

# make os
export PLATFORM=bcm-rpi
make clean
make
${CROSS_COMPILE}objcopy -O binary out/arm-plat-bcm/core/tee.elf optee.bin
${CROSS_COMPILE}objdump -d binary out/arm-plat-bcm/core/tee.elf > optee.asm

export CROSS_COMPILE=${BUILDROOT}output/host/usr/bin/arm-none-linux-gnueabi-

# make client
cd ${OPTEEC}
make clean
make
cp out/tee-supplicant/tee-supplicant ${BUILDROOT}output/target/root/
cp out/libteec/libteec.so.1.0 ${BUILDROOT}output/target/lib/
cd -

# make test
cd ${OPTEET}
export CROSS_COMPILE_HOST=${CROSS_COMPILE}
export CROSS_COMPILE_TA=${CROSS_COMPILE}
export TA_DEV_KIT_DIR=${OPTEES}/out/arm-plat-bcm/export-user_ta
make clean
make
rm -rf ${BUILDROOT}output/target/root/ta/
mkdir -p ${BUILDROOT}output/target/root/ta/
cp out/xtest/xtest ${BUILDROOT}output/target/root/
cp out/ta/*/*.ta ${BUILDROOT}output/target/root/ta/
cd -
cd ${BUILDROOT}output/target/lib/
rm optee_armtz
ln -s ../root/ta optee_armtz
cd -

#JTAG mux
${CROSS_COMPILE}g++ JtagEnabler.cpp -o JtagEnabler
mv JtagEnabler ${BUILDROOT}output/target/root/

# make kernel
cd /local/home/roman/projects/zyboradio/buildroot
make linux-rebuild
cd -

# make driver
cd ${BUILDROOT}output/build/linux-4.0.4/
make M=${OPTEEL}
#${CROSS_COMPILE}objdump -l -x -d ${OPTEEL}core/optee.ko > ${OPTEEL}optee.dmp
#${CROSS_COMPILE}objdump -l -x -d ${OPTEEL}armtz/optee_armtz.ko > ${OPTEEL}optee_armtz.dmp
cp ${OPTEEL}core/optee.ko ../../target/root/
cp ${OPTEEL}armtz/optee_armtz.ko ../../target/root/
cd -

# make script
cat << EOF > rb
insmod optee.ko
insmod optee_armtz.ko
./tee-supplicant &
EOF
chmod +x rb
mv rb ${BUILDROOT}output/target/root/

# make rootfs
cd /local/home/roman/projects/zyboradio/buildroot
make
cd -

#fatload mmc 0:1 8000 zImage; bootz 8000
#run bootcmd_sd
#fixed console from tty1 to ttyAMA0 in buildroot
#kernel added CONFIG_DMA_SHARED_BUFFER (MEDIA_SUPPORT+MEDIA_CAMERA_SUPPORT+V4L_PLATFORM_DRIVERS+VIDEO_BCM2835_MMAL+DMADEVICES)
#http://sandsoftwaresound.net/raspberry-pi/arm11-microarchitecture/

# kernel 4.0.4 CONFIG_MODULES CONFIG_DMADEVICES +VIVID CONFIG_EARLY_PRINTK DMADEVICES DMA_BCM2835
# earlyprintk=serial,uart0,115200
#fatload mmc 0:1 8000 zImage; fatload mmc 0:1 100 bcm2835-rpi-b.dtb; bootz 8000 - 100

