export DEBUG=1
export ARCH=arm
export CROSS_COMPILE=/local/home/roman/projects/zyboradio/buildroot/output/host/usr/bin/arm-none-linux-gnueabi-
export CFG_ARM32=y
export CFG_TEE_CORE_CORE_TARGET=arm1176jzf-s
export CFG_TEE_CORE_LOG_LEVEL=4

# make os
export PLATFORM=bcm-rpi
make clean
make
${CROSS_COMPILE}objcopy -O binary out/arm-plat-bcm/core/tee.elf optee.bin

# make client
cd /local/home/roman/projects/optee_client/
make clean
make
cp out/tee-supplicant/tee-supplicant /local/home/roman/projects/zyboradio/buildroot/output/target/root/
cp out/libteec/libteec.so.1.0 /local/home/roman/projects/zyboradio/buildroot/output/target/lib/
cd -

# make test
cd /local/home/roman/projects/optee_test/
export CROSS_COMPILE_HOST=${CROSS_COMPILE}
export CROSS_COMPILE_TA=${CROSS_COMPILE}
export TA_DEV_KIT_DIR=/local/home/roman/projects/optee_os/out/arm-plat-bcm/export-user_ta
make clean
make
cp out/xtest/xtest /local/home/roman/projects/zyboradio/buildroot/output/target/root/
cd -

#JTAG mux
${CROSS_COMPILE}g++ JtagEnabler.cpp -o JtagEnabler
mv JtagEnabler /local/home/roman/projects/zyboradio/buildroot/output/target/root/

# make kernel
cd /local/home/roman/projects/zyboradio/buildroot
make linux-rebuild
cd -

# make driver
cd /local/home/roman/projects/zyboradio/buildroot/output/build/linux-4.0.4/
make M=/home/roman/projects/optee_linuxdriver/
#${CROSS_COMPILE}objdump -l -x -d /home/roman/projects/optee_linuxdriver/core/optee.ko > /home/roman/projects/optee_linuxdriver/optee.dmp
#${CROSS_COMPILE}objdump -l -x -d /home/roman/projects/optee_linuxdriver/armtz/optee_armtz.ko > /home/roman/projects/optee_linuxdriver/optee_armtz.dmp
cp /home/roman/projects/optee_linuxdriver/core/optee.ko ../../target/root/
cp /home/roman/projects/optee_linuxdriver/armtz/optee_armtz.ko ../../target/root/
cd -

# make script
cat << EOF > rb
insmod optee.ko
insmod optee_armtz.ko
./tee-supplicant &
EOF
chmod +x rb
mv rb /local/home/roman/projects/zyboradio/buildroot/output/target/root/

# make rootfs
cd /local/home/roman/projects/zyboradio/buildroot
make
cd -

#fatload mmc 0:1 8000 zImage; bootz 8000
#run bootcmd_sd
#fixed console from tty1 to ttyAMA0 in buildroot
#kernel added CONFIG_DMA_SHARED_BUFFER (MEDIA_SUPPORT+MEDIA_CAMERA_SUPPORT+V4L_PLATFORM_DRIVERS+VIDEO_BCM2835_MMAL+DMADEVICES)
#http://sandsoftwaresound.net/raspberry-pi/arm11-microarchitecture/

# kernel 4.0.4 CONFIG_MODULES CONFIG_DMADEVICES +VIVID CONFIG_EARLY_PRINTK DMADEVICES DMA_BCM2835
# earlyprintk=serial,uart0,115200
#fatload mmc 0:1 8000 zImage; fatload mmc 0:1 100 bcm2835-rpi-b.dtb; bootz 8000 - 100

